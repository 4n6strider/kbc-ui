React = require 'react'
Router = require 'react-router'
Promise = require 'bluebird'
_ = require 'underscore'

routes = require './routes.coffee'
createReactRouterRoutes = require './utils/createReactRouterRoutes.coffee'

ApplicationActionCreators = require './actions/ApplicationActionCreators.coffee'
ComponentsActionCreators = require './modules/components/ComponentsActionCreators.coffee'
InstalledComponentsActionCreators = require './modules/components/InstalledComponentsActionCreators.coffee'
RouterActionCreators = require './actions/RouterActionCreators.coffee'

NoTokenPage = require './components/debug/NoTokenPage.coffee'

RoutesStore = require './stores/RoutesStore.coffee'
App = require './components/App.coffee'


getParameterByName = (name, searchString) ->
  name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]")
  regex = new RegExp("[\\?&]" + name + "=([^&#]*)")
  results = regex.exec(searchString)
  (if not results? then "" else decodeURIComponent(results[1].replace(/\+/g, " ")))



token = getParameterByName('token', window.location.search)
if !token
  React.render(React.createElement(NoTokenPage), document.getElementById 'react')
  return

# init stores
ComponentsActionCreators.receiveAllComponents([{"id":"ex-adocean","type":"extractor","name":"AdOcean","description":"See the efficiency of your web banners","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/adocean32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/adocean64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-adocean"},{"id":"ex-adwords","type":"extractor","name":"Google Adwords","description":"Advertise with Google","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/google-adwords32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/google-adwords64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-adwords"},{"id":"ex-cloudsearch","type":"extractor","name":"AWS Cloudsearch","description":"Search service for AWS Cloud","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/cloudsearch32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/cloudsearch64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-cloudsearch"},{"id":"ex-constantcontact","type":"extractor","name":"Constant Contact","description":"Small business marketing service","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/constant-contact32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/constant-contact64-1.png","uri":"https:\/\/syrup.keboola.com\/constantcontact"},{"id":"ex-currency","type":"extractor","name":"Currency","description":"Convert your money to different currencies","hasUI":false,"hasRun":true,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/ex-currency"},{"id":"ex-db","type":"extractor","name":"Database Extractor","description":"Fetch data from MySQL or MSSQL","hasUI":true,"hasRun":true,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/ex-db"},{"id":"ex-doubleclick","type":"extractor","name":"Google DoubleClick extractor","description":"Export your DoubleClick reports from DFA","hasUI":false,"hasRun":true,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/ex-doubleclick"},{"id":"ex-elasticsearch","type":"extractor","name":"Elasticsearch","description":"End-to-end search and analytics platform","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/elasticsearch32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/elasticsearch64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-elasticsearch"},{"id":"ex-facebook","type":"extractor","name":"Facebook","description":"Get the data from your social network","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/facebook32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/facebook64-1.png","uri":"https:\/\/ex-facebook.keboola.com"},{"id":"ex-facebook-ads","type":"extractor","name":"Facebook Ads","description":"Advertise with Facebook","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/facebook-ads32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/facebook-ads64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-facebook-ads"},{"id":"ex-gooddata","type":"extractor","name":"Gooddata","description":"Download reports from GoodData","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/gooddata32-2.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/gooddata64-2.png","uri":"https:\/\/syrup.keboola.com\/ex-gooddata"},{"id":"ex-google-analytics","type":"extractor","name":"Google Analytics","description":"Web analytics & reporting","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/Google-Analytics-icon-32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/Google-Analytics-icon-64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-google-analytics"},{"id":"ex-google-drive","type":"extractor","name":"Google Drive","description":"Extract spreadsheet data from Google Drive","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/Google-Drive-icon-32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/Google-Drive-icon-64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-google-drive"},{"id":"ex-http","type":null,"name":null,"description":null,"hasUI":false,"hasRun":false,"ico32":null,"ico64":null,"uri":"https:\/\/syrup.keboola.com\/restbox"},{"id":"ex-instagram","type":"extractor","name":"Instagram","description":"Get the data from Instagram","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/instagram-32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/instagram-64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-instagram"},{"id":"ex-mailchimp","type":"extractor","name":"Mailchimp","description":"Send Better Email","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/mailchimp-32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/mailchimp-64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-mailchimp"},{"id":"ex-mscrm","type":"extractor","name":"MS Dynamics CRM","description":"Microsoft\u2019s CRM solution","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/microsoft-dynamics32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/microsoft-dynamics64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-mscrm"},{"id":"ex-netsuite","type":"extractor","name":"Netsuite","description":"The #1 Cloud Business Management Software Suite","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/netsuite32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/netsuite64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-netsuite"},{"id":"ex-ooyala","type":"extractor","name":"Ooyala","description":"Reach, Measure & Monetize Online Video","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/ooyala32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/ooyala64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-ooyala"},{"id":"ex-paymo","type":"extractor","name":"Paymo","description":"Time tracking & billing app","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/paymo32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/paymo64-1.png","uri":"https:\/\/paymo.keboola.com"},{"id":"ex-pingdom","type":"extractor","name":"Pingdom","description":"Uptime and performance monitoring made easy","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/pingdom-32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/pingdom-64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-pingdom"},{"id":"ex-recurly","type":"extractor","name":"Recurly","description":"Recurring billing platform","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/recurly32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/recurly64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-recurly"},{"id":"ex-s3","type":"extractor","name":"AWS S3","description":"Cloud storage for the Internet","hasUI":false,"hasRun":false,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/cloudsearch32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/cloudsearch64-1.png","uri":"https:\/\/syrup.keboola.com\/restbox"},{"id":"ex-salesforce","type":"extractor","name":"SalesForce.com (Beta)","description":"World\u2019s #1 CRM sales app.","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/salesforce32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/salesforce64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-salesforce"},{"id":"ex-sapi","type":"extractor","name":"Keboola Storage API","description":"Cloud staging layer","hasUI":false,"hasRun":false,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/restbox"},{"id":"ex-sfdc","type":"extractor","name":"SalesForce.com","description":"World\u2019s #1 CRM sales app.","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/salesforce32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/salesforce64-1.png","uri":"https:\/\/sfdc.keboola.com"},{"id":"ex-sklik","type":"extractor","name":"Sklik","description":"Advertise with Seznam.cz","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/sklik32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/sklik64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-sklik"},{"id":"ex-telfa","type":"extractor","name":"Telfa","description":"Phone system for any orgranization","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/telfa32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/telfa64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-telfa"},{"id":"ex-twitter","type":"extractor","name":"Twitter","description":"Get the data from your social network","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/twitter32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/twitter64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-twitter"},{"id":"ex-youtube","type":"extractor","name":"Youtube","description":"Fetch data from Youtube Analytics","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/YouTube-icon-32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/YouTube-icon-64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-google-youtube"},{"id":"ex-zendesk","type":"extractor","name":"Zendesk","description":"Software for better customer service","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/zendesk-32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/zendesk-64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-zendesk"},{"id":"gooddata-writer","type":"writer","name":"GoodData","description":"The Open Analytics Platform","hasUI":true,"hasRun":false,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/gooddata32-2.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/gooddata64-2.png","uri":"https:\/\/syrup.keboola.com\/gooddata-writer"},{"id":"orchestrator","type":"other","name":"Orchestrator","description":"Jobs scheduler","hasUI":false,"hasRun":false,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/orchestrator"},{"id":"orchestrator-2","type":"other","name":"Orchestrator","description":"","hasUI":false,"hasRun":false,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/orchestrator"},{"id":"pebble","type":"writer","name":"wr-iot","description":"internet of things writer(FKA pebble)","hasUI":false,"hasRun":false,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/pebble-32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/pebble-64-1.png","uri":"https:\/\/syrup.keboola.com\/wr-iot"},{"id":"provisioning","type":"other","name":"Provisioning","description":"Transformation engine provisioning","hasUI":false,"hasRun":false,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/provisioning"},{"id":"queue","type":"other","name":"Queue","description":"Queue","hasUI":false,"hasRun":false,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/queue"},{"id":"restbox","type":"extractor","name":"REST Box","description":"Custom HTTP component","hasUI":true,"hasRun":true,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/restbox"},{"id":"rt-lucky-guess","type":"other","name":"Lucky Guess","description":"Lucky Guess","hasUI":false,"hasRun":false,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/rt-lucky-guess"},{"id":"transformation","type":"transformation","name":"Transformations","description":"Transform data","hasUI":false,"hasRun":false,"ico32":"","ico64":"","uri":"https:\/\/transformation.keboola.com"},{"id":"wr-cloudsearch","type":"writer","name":"AWS Cloudsearch","description":"Search service for AWS Cloud","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/cloudsearch32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/cloudsearch64-1.png","uri":"https:\/\/syrup.keboola.com\/wr-cloudsearch"},{"id":"wr-db","type":"writer","name":"Database writer","description":"Write data to MySQL","hasUI":true,"hasRun":true,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/wr-db"},{"id":"wr-elasticsearch","type":"writer","name":"Elasticsearch","description":"End-to-end search and analytics platform","hasUI":false,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/elasticsearch32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/elasticsearch64-1.png","uri":"https:\/\/syrup.keboola.com\/wr-elasticsearch"},{"id":"wr-tableau","type":"writer","name":"Tableau","description":"Writer to Tableau","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/tableau-32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/tableau-64-1.png","uri":"https:\/\/syrup.keboola.com\/wr-db"}])
InstalledComponentsActionCreators.receiveAllComponents([{"id":"ex-db","type":"extractor","name":"Database Extractor","description":"Fetch data from MySQL or MSSQL","hasUI":true,"hasRun":true,"ico32":"","ico64":"","uri":"https:\/\/syrup.keboola.com\/ex-db","configurations":[{"id":"Academy","name":"Academy","description":"","created":"2014-05-07T09:24:57+0200","creatorToken":{"id":491,"description":"Master Token"}},{"id":"Pohoda","name":"Pohoda","description":"","created":"2014-05-07T09:25:02+0200","creatorToken":{"id":491,"description":"Master Token"}}]},{"id":"ex-gooddata","type":"extractor","name":"Gooddata","description":"Download reports from GoodData","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/gooddata32-2.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/gooddata64-2.png","uri":"https:\/\/syrup.keboola.com\/ex-gooddata","configurations":[{"id":"academyrevenue","name":"AcademyRevenue","description":"Pulling Partner Revenue from the Academy Admin GD project","created":"2014-11-15T01:32:40+0100","creatorToken":{"id":3677,"description":"milan@keboola.com"}},{"id":"pebblerevenue","name":"PebbleRevenue","description":"Monitoring of complete revenue for the Pebble app","created":"2014-07-10T23:51:27+0200","creatorToken":{"id":491,"description":"Master Token"}}]},{"id":"ex-google-drive","type":"extractor","name":"Google Drive","description":"Extract spreadsheet data from Google Drive","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/Google-Drive-icon-32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/Google-Drive-icon-64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-google-drive","configurations":[{"id":"account0","name":"account-0","description":"","created":"2014-01-27T17:23:55+0100","creatorToken":{"id":491,"description":"Master Token"}}]},{"id":"ex-zendesk","type":"extractor","name":"Zendesk","description":"Software for better customer service","hasUI":true,"hasRun":true,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/zendesk-32-1.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/zendesk-64-1.png","uri":"https:\/\/syrup.keboola.com\/ex-zendesk","configurations":[{"id":"tickets","name":"tickets","description":"","created":"2014-08-14T15:02:05+0200","creatorToken":{"id":491,"description":"Master Token"}}]},{"id":"gooddata-writer","type":"writer","name":"GoodData","description":"The Open Analytics Platform","hasUI":true,"hasRun":false,"ico32":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/gooddata32-2.png","ico64":"https:\/\/d3iz2gfan5zufq.cloudfront.net\/images\/cloud-services\/gooddata64-2.png","uri":"https:\/\/syrup.keboola.com\/gooddata-writer","configurations":[{"id":"1091","name":"1091","description":"","created":"2012-10-31T16:27:34+0100","creatorToken":{"id":491,"description":"Master Token"}},{"id":"Academy_Import","name":"Academy_Import","description":"Academy admin project, here for data export purposes, potentially to push usage in.","created":"2014-11-15T01:31:21+0100","creatorToken":{"id":3677,"description":"milan@keboola.com"}},{"id":"KB_PM","name":"KB_PM","description":"","created":"2013-04-28T02:32:53+0200","creatorToken":{"id":491,"description":"Master Token"}}]},{"id":"transformation","type":"transformation","name":"Transformations","description":"Transform data","hasUI":false,"hasRun":false,"ico32":"","ico64":"","uri":"https:\/\/transformation.keboola.com","configurations":[{"id":"sys.c-tr-gdprices","name":"sys.c-tr-gdprices","description":"GD Price list","created":"2014-02-21T01:03:45+0100","creatorToken":{"id":491,"description":"Master Token"}},{"id":"sys.c-tr-gdstats","name":"sys.c-tr-gdstats","description":"GD projects","created":"2014-01-12T05:11:00+0100","creatorToken":{"id":491,"description":"Master Token"}},{"id":"sys.c-tr-pebble","name":"sys.c-tr-pebble","description":"Get pebble data ready!","created":"2014-07-11T01:44:55+0200","creatorToken":{"id":491,"description":"Master Token"}},{"id":"sys.c-tr-redshift","name":"sys.c-tr-redshift","description":"Redshift transformations","created":"2014-02-21T14:16:38+0100","creatorToken":{"id":491,"description":"Master Token"}},{"id":"sys.c-tr-usagestats","name":"sys.c-tr-usagestats","description":"KBC and GD data all together mixed into Paymo","created":"2014-06-14T00:19:51+0200","creatorToken":{"id":491,"description":"Master Token"}},{"id":"sys.c-transformation","name":"sys.c-transformation","description":"Transformations","created":"2012-10-10T15:32:52+0200","creatorToken":{"id":491,"description":"Master Token"}}]}])

ApplicationActionCreators.receiveApplicationData(
  sapiUrl: 'https://connection.keboola.com'
  sapiToken:
    token: token
)

RouterActionCreators.routesConfigurationReceive(routes)

router = Router.create
  routes: createReactRouterRoutes(routes)
  location: Router.HashLocation


Promise.longStackTraces()

rootNode = document.getElementById 'react'

# Show loading page before app is ready
loading = _.once (Handler) ->
  React.render(React.createElement(Handler, isLoading: true), rootNode)

# re-render after each route change
router.run (Handler, state) ->

  # run only once on first render
  loading(Handler)

  # async data handling inspired by https://github.com/rackt/react-router/blob/master/examples/async-data/app.js
  promises = RoutesStore
    .getRequireDataFunctionsForRouterState(state.routes)
    .map((requireData) ->
      requireData(state.params)
    ).toArray()

  # wait for data and trigger render
  Promise.all(promises)
    .then(->
      RouterActionCreators.routeChange(state)
      React.render(React.createElement(Handler), rootNode)
    )
    .catch((error) ->
      # render error page
      RouterActionCreators.routeChangeError(error)
      React.render(React.createElement(Handler, isError: true), rootNode)
    )

